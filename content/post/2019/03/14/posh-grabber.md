---
title: "Posh Grabber"
date: 2019-03-14T13:16:19+03:00
Tags: ["powershell","wget", "ni", "gc"]
Categories: ["scripts", "offwork"]
#Toc: true
---

И начнём мы с небольшого posh скрипта, который меня попросил написать знакомый, который сейчас увлёкся дмством по ДнД (что, ко моему мнению немного странно в 2019 году, но это на его совести). 
<!--more-->
### Дано:

 * Необходимо выкачать различный арт для личного использования. Ссылки на арт находятся в файле.
 * Ставить какой-либо софт очень не хочется, а руками качать - долго и неудобно.

### Проблема

 * Арт хранится в хранилище S3, так что с названиями файлов всё плохо - они одинаковые.

### Решение:

Так как знакомый является пользователем винды (как, впрочем, и я), то в качестве быстрого решения был накидан скрипт, который быстро выкачал ему все необходимые файлы.

```powershell 
$links = Get-Content -Path .\files.txt
$path = ".\download"
$ext = ".png"

New-Item -Path $path -ItemType Directory
foreach ($link in $links) {
    $filename = Split-Path(Split-Path($link)) -Leaf
    $newname = Join-Path $path $filename
    $newname = $newname + $ext
    Invoke-WebRequest -Uri $link -OutFile $newname
}
```

Его логика работы элементарна:

* читаем массив ссылок из файла *files.txt* в текущей папке, 
* создаём себе папку *download*, куда будем складывать скачанное
* проходим циклом по всему массиву ссылок, творим небольшую магию над именами файлов и натравливаем на ссылки Invoke-WebRequest.

Насчёт магии немного подробнее: <br>
Я попросил примеры ссылок и получил подобное:

```txt
https://s3.amazonaws.com/hostname/folder/id/1H0HLPmh31Of96L2cLVKeQ/max.png?1513023179
```

Докинем предположение, что между *folder* и *max.png* у нас содержится хэш объекта (или что-то другое, но уникальное для каждого объекта), причём id - это некий внутренний номер объекта, а дальше идёт именно хэш. Вот его и будем использовать в качестве имени файла.<br>
А поможет нам в этом [Split-Path
](https://docs.microsoft.com/ru-ru/powershell/module/microsoft.powershell.management/split-path?view=powershell-6). Причём дважды - в первый раз мы отрежем и откинем последний элемент (это будет имя файла со всеми хвостами), а во второй - наоборот, последний элемент сохраним, это будет наш хэш. Вот его мы и вклеим между путём к папке *download* и расширением *png*, чтобы получить нужный конечный адрес для загрузки.

Написав вон то выше я понимаю, что это можно было решить элегантнее и красивее, но на тот момент этого хватило. Все файлы были благополучно скачаны.
